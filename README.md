# CloudExpat GitHub Action Example

[![CloudExpat Cost Report](https://github.com/cloudexpat/cloudexpat-github-action-example/actions/workflows/cloudexpat-cost-report.yml/badge.svg)](https://github.com/cloudexpat/cloudexpat-github-action-example/actions/workflows/cloudexpat-cost-report.yml)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

Automatically post cloud cost and carbon footprint reports to your Pull Requests using [CloudExpat](https://cloudexpat.com).

## What You Get

When a Pull Request is opened, the GitHub Action automatically posts a comment with:

- **Cost Summary** - Cloud spending across all your connected accounts
- **Carbon Footprint** - Environmental impact of your cloud usage
- **Trend Analysis** - Week-over-week changes with percentage indicators

### Example PR Comment

```
## CloudExpat Cost Report

**Report Period**: Dec 16 - Dec 23, 2025

### Cost Summary

| Account          | Provider | This Week  | Last Week  | Change  |
|------------------|----------|------------|------------|---------|
| Production       | AWS      | $2,450.00  | $2,200.00  | +11.4%  |
| Staging          | Azure    | $340.00    | $380.00    | -10.5%  |
| Analytics        | GCP      | $520.00    | $510.00    | +2.0%   |
| **Total**        |          | **$3,310** | **$3,090** | **+7.1%** |

### Carbon Emissions

| Account          | This Week    | Last Week    | Change  |
|------------------|--------------|--------------|---------|
| Production       | 245 kgCO2e   | 220 kgCO2e   | +11.4%  |
| Staging          | 34 kgCO2e    | 38 kgCO2e    | -10.5%  |
| Analytics        | 52 kgCO2e    | 51 kgCO2e    | +2.0%   |
| **Total**        | **331 kgCO2e** | **309 kgCO2e** | **+7.1%** |

---
Generated by CloudExpat | View Dashboard
```

## Quick Start

### 1. Get Your API Key

1. Log in to [CloudExpat](https://app.cloudexpat.com)
2. Go to **Settings** > **API Keys**
3. Click **Create API Key**
4. Copy the key (starts with `ce_live_`)

### 2. Add the Secret to Your Repository

1. In your GitHub repository, go to **Settings** > **Secrets and variables** > **Actions**
2. Click **New repository secret**
3. Name: `CLOUDEXPAT_API_KEY`
4. Value: Paste your API key

### 3. Add the Workflow File

Copy the workflow file to your repository:

```
your-repo/
└── .github/
    └── workflows/
        └── cloudexpat-cost-report.yml
```

You can copy it from this repository or create it manually using the template below.

### 4. Open a Pull Request

That's it! The action runs automatically on every PR.

## Workflow File

Create `.github/workflows/cloudexpat-cost-report.yml`:

```yaml
name: CloudExpat Cost Report

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  cost-report:
    name: Generate Cost Report
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Cost Report
        id: fetch-report
        env:
          CLOUDEXPAT_API_KEY: ${{ secrets.CLOUDEXPAT_API_KEY }}
        run: |
          if [ -z "$CLOUDEXPAT_API_KEY" ]; then
            echo "::error::CLOUDEXPAT_API_KEY secret is not set"
            exit 1
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "https://data.cloudexpat.com/v1/report?format=markdown" \
            -H "Authorization: Bearer ${CLOUDEXPAT_API_KEY}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API request failed with HTTP $HTTP_CODE"
            exit 1
          fi

          echo "$BODY" > report.md
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('CloudExpat Cost Report')
            );

            const body = report + '\n\n---\n<sub>Generated by [CloudExpat](https://cloudexpat.com)</sub>';

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Add to Job Summary
        run: cat report.md >> $GITHUB_STEP_SUMMARY
```

## Configuration Options

### Trigger Options

```yaml
on:
  # On every PR (default)
  pull_request:
    types: [opened, synchronize, reopened]

  # Manual trigger from Actions tab
  workflow_dispatch:

  # Weekly schedule (Monday 9am UTC)
  schedule:
    - cron: '0 9 * * 1'

  # On push to main branch
  push:
    branches: [main]
```

### Branch Filtering

Only run on PRs targeting specific branches:

```yaml
on:
  pull_request:
    branches: [main, develop]
```

## Multi-Cloud Support

CloudExpat aggregates costs across all your connected cloud accounts:

| Provider | Supported |
|----------|-----------|
| AWS      | Yes       |
| Azure    | Yes       |
| GCP      | Yes       |

Connect your accounts at [app.cloudexpat.com](https://app.cloudexpat.com).

## Troubleshooting

### "CLOUDEXPAT_API_KEY secret is not set"

Make sure you've added the secret correctly:
1. Go to repository **Settings** > **Secrets and variables** > **Actions**
2. Verify the secret name is exactly `CLOUDEXPAT_API_KEY`

### "API request failed with HTTP 401"

Your API key may be invalid or expired. Generate a new one at [app.cloudexpat.com/dashboard/settings/api-keys](https://app.cloudexpat.com/dashboard/settings/api-keys).

### "API request failed with HTTP 403"

Your API key doesn't have access to any cloud accounts. Make sure you've connected at least one AWS, Azure, or GCP account in CloudExpat.

### No comment appears on PR

Check that the workflow has `pull-requests: write` permission and that GitHub Actions is enabled for your repository.

## Security

- API keys should only be stored as GitHub Secrets, never committed to code
- The workflow only requires `pull-requests: write` and `contents: read` permissions
- API keys can be revoked at any time from the CloudExpat dashboard

## Support

- [Documentation](https://docs.cloudexpat.com)
- [Contact Support](mailto:support@cloudexpat.com)
- [Report Issues](https://github.com/cloudexpat/cloudexpat-github-action-example/issues)

## License

MIT License - see [LICENSE](LICENSE) for details.

